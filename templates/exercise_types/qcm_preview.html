{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="mb-4">
        <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left"></i> Retour au tableau de bord
        </a>
    </div>

    {% if content and content.questions %}
    <div class="qcm-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{ exercise.title }}</h2>
            {% if current_user.is_teacher and current_user.id == exercise.teacher_id %}
            <div>
                <a href="{{ url_for('edit_exercise', exercise_id=exercise.id) }}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Modifier
                </a>
                <button type="button" class="btn btn-danger" data-exercise-id="{{ exercise.id }}" onclick="deleteExercise(this.dataset.exerciseId)">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            </div>
            {% endif %}
        </div>

        <form method="POST" action="{{ url_for('submit_exercise_answer', exercise_id=exercise.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% for question in content.questions %}
            <div class="question-block mb-4">
                <div class="question-text mb-3">
                    <span class="question-number">{{ loop.index }}.</span>
                    {{ question.text }}
                </div>
                <div class="options-list">
                    {% set question_index = loop.index0 %}
                    {% for choice in question.choices %}
                        <div class="form-check custom-radio mb-2">
                            <input class="form-check-input" type="radio" 
                                   name="question_{{ question_index }}" 
                                   id="option_{{ question_index }}_{{ loop.index0 }}"
                                   value="{{ loop.index0 }}"
                                   {% if attempt and attempt.answers[question_index] == loop.index0 %}checked{% endif %}
                                   {% if attempt %}disabled{% endif %}>
                            <label class="form-check-label" for="option_{{ question_index }}_{{ loop.index0 }}">
                                {{ choice }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
                
                {% if attempt %}
                    <div class="mt-3">
                        {% if attempt.answers[question_index] == question.correct_answer %}
                            <div class="alert alert-success">
                                <i class="fas fa-check"></i> Correct !
                            </div>
                        {% else %}
                            <div class="alert alert-danger">
                                <i class="fas fa-times"></i> Incorrect. La bonne réponse était : {{ question.choices[question.correct_answer] }}
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endfor %}
            
            {% if not attempt %}
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-check"></i> Valider mes réponses
                </button>
            </div>
            {% endif %}
        </form>
    </div>
    {% else %}
    <div class="alert alert-warning">
        Aucune question n'a été définie pour cet exercice.
    </div>
    {% endif %}
</div>
{% endblock %}

<script>
function deleteExercise(exerciseId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet exercice ?')) {
        fetch(`/delete_exercise/${exerciseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/exercises';
            } else {
                alert('Erreur lors de la suppression de l\'exercice');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la suppression de l\'exercice');
        });
    }
}
</script>

<script>
function validateForm() {
    // Vérifier qu'au moins une réponse est sélectionnée pour chaque question
    const questions = document.querySelectorAll('.question-block');
    let isValid = true;

    questions.forEach(question => {
        const radioButtons = question.querySelectorAll('input[type="radio"]:checked');
        if (radioButtons.length === 0) {
            isValid = false;
            // Afficher un message d'erreur près de la question
            const errorDiv = question.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.textContent = 'Veuillez sélectionner une réponse';
                errorDiv.style.display = 'block';
            }
        }
    });

    return isValid;
}

// Effacer les messages d'erreur lorsqu'une réponse est sélectionnée
document.addEventListener('change', function(e) {
    if (e.target.type === 'radio') {
        const questionBlock = e.target.closest('.question-block');
        if (questionBlock) {
            const errorDiv = questionBlock.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
    }
});
</script>

<style>
.qcm-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.question-block {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
}

.question-text {
    font-size: 1.1em;
    color: #2c3e50;
    margin-bottom: 15px;
    line-height: 1.5;
}

.question-number {
    font-weight: bold;
    color: #2196f3;
    margin-right: 8px;
}

.options-list {
    margin-left: 25px;
}

.form-check.custom-radio {
    padding: 12px 15px;
    margin-bottom: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.form-check.custom-radio:hover {
    background-color: #f5f5f5;
    border-color: #2196f3;
    transform: translateX(5px);
}

.form-check-input:checked + .form-check-label {
    font-weight: 600;
    color: #2196f3;
}

.form-check.custom-radio:has(.form-check-input:checked) {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

.alert {
    margin-top: 15px;
    margin-bottom: 0;
    border-radius: 6px;
}

.alert-success {
    background-color: #e8f5e9;
    border-color: #4caf50;
    color: #2e7d32;
}

.alert-danger {
    background-color: #ffebee;
    border-color: #f44336;
    color: #c62828;
}

.btn-primary {
    background-color: #2196f3;
    border-color: #2196f3;
    padding: 8px 20px;
    font-weight: 500;
}

.btn-primary:hover {
    background-color: #1976d2;
    border-color: #1976d2;
    transform: translateY(-1px);
}

.btn-danger {
    padding: 8px 20px;
    font-weight: 500;
}

@media (max-width: 768px) {
    .qcm-container {
        padding: 15px;
    }

    .question-block {
        padding: 15px;
    }

    .form-check.custom-radio {
        padding: 10px;
    }

    .question-text {
        font-size: 1em;
    }
}
</style>
